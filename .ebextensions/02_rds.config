Resources:
  AWSEBRDSDatabase:
    Type: "AWS::RDS::DBInstance"
    Properties:
      AllocatedStorage: "20"
      DBInstanceClass: "db.t4g.micro"
      Engine: "postgres"
      EngineVersion: "17"
      MasterUsername: "postgres"
      MasterUserPassword: "mysecretpassword"
      DBName: "blacklist_db"
      VPCSecurityGroups:
        - {"Fn::GetAtt" : ["AWSEBSecurityGroup", "GroupId"]}

  DBEndpointSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: blacklist-db-endpoint
      Description: Database endpoint for blacklist app
      SecretString: 
        Fn::Sub: |
          {
            "hostname": "${AWSEBRDSDatabase.Endpoint.Address}",
            "port": "${AWSEBRDSDatabase.Endpoint.Port}"
          }

option_settings:
  aws:elasticbeanstalk:application:environment:
    RDS_DB_NAME: "blacklist_db"
    RDS_USERNAME: "postgres"
    SECRET_KEY:
      "Fn::Sub": "{{resolve:secretsmanager:blacklist-app-secrets:SecretString:secret_key}}"

    JWT_SECRET_KEY: "super-secret"